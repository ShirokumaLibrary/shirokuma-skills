# Internationalization (i18n) Patterns

Related: [known-issues.md](../issues/known-issues.md) (next-intl), [code-quality.md](../criteria/code-quality.md)

## Configuration

### Routing Configuration

```typescript
// i18n/routing.ts
import { defineRouting } from "next-intl/routing"

export const routing = defineRouting({
  locales: ["ja", "en"],
  defaultLocale: "ja",
  localePrefix: "never",  // Cookie-based, no URL prefix
})
```

### Request Configuration

```typescript
// i18n/request.ts
import { getRequestConfig } from "next-intl/server"
import { routing } from "./routing"

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale
  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale
  }

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
  }
})
```

## Server Components

### Required: setRequestLocale

**CRITICAL**: Must call `setRequestLocale` at top of every Server Component page:

```typescript
import { getTranslations, setRequestLocale } from "next-intl/server"

export default async function Page({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params
  setRequestLocale(locale)  // Required for static rendering!

  const t = await getTranslations("common")
  return <h1>{t("title")}</h1>
}
```

**Error if missing**: Static rendering fails, translations work but slow.

### Namespace-Based Translations

```typescript
// Get translations from specific namespace
const t = await getTranslations("posts")
t("title")  // messages.posts.title

// Multiple namespaces
const [tCommon, tPosts] = await Promise.all([
  getTranslations("common"),
  getTranslations("posts"),
])
```

## Client Components

```typescript
"use client"
import { useTranslations, useLocale } from "next-intl"

export function MyComponent() {
  const t = useTranslations("namespace")
  const locale = useLocale()

  return <button>{t("submit")}</button>
}
```

### With Provider

```typescript
import { NextIntlClientProvider } from "next-intl"

function renderWithProviders(ui: React.ReactElement, locale = "en") {
  const messages = { common: { save: "Save" } }
  return render(
    <NextIntlClientProvider locale={locale} messages={messages}>
      {ui}
    </NextIntlClientProvider>
  )
}
```

## Translation Files

### Structure

```json
// messages/ja.json
{
  "common": {
    "save": "保存",
    "cancel": "キャンセル",
    "logout": "ログアウト"
  },
  "posts": {
    "title": "記事一覧",
    "readMore": "続きを読む"
  },
  "auth": {
    "loginError": "メールアドレスまたはパスワードが正しくありません"
  }
}
```

### Interpolation

```json
{
  "postsCount": "{count}件の記事",
  "greeting": "{name}さん、こんにちは"
}
```

```typescript
t("postsCount", { count: 10 })  // "10件の記事"
t("greeting", { name: "田中" })  // "田中さん、こんにちは"
```

## Date Formatting

```typescript
const dateLocale = locale === "ja" ? "ja-JP" : "en-US"

post.publishedAt.toLocaleDateString(dateLocale, {
  year: "numeric",
  month: "long",
  day: "numeric",
})
// Japanese: "2025年11月28日"
// English: "November 28, 2025"
```

## Japanese URL Slugs

URL-encoded Japanese characters need decoding:

```typescript
// URL: /tag/%E6%97%A5%E6%9C%AC%E8%AA%9E
export default async function TagPage({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params
  const decodedSlug = decodeURIComponent(slug)  // "日本語"
  const tag = await getTagBySlug(decodedSlug)
}
```

**Error if not decoded**: 404 for Japanese tag/category pages.

## Testing Patterns

### Mocking next-intl

```typescript
// jest.setup.ts
jest.mock("next-intl", () => ({
  useTranslations: () => (key: string) => key,
  useLocale: () => "ja",
}))
```

### Testing with Full i18n

```typescript
import { NextIntlClientProvider } from "next-intl"

const messages = {
  common: { save: "Save" },
  features: { title: "Features" },
}

function renderWithIntl(ui: React.ReactElement) {
  return render(
    <NextIntlClientProvider locale="en" messages={messages}>
      {ui}
    </NextIntlClientProvider>
  )
}
```

## Known Issues

### Next.js 16 Compatibility (Issue #2064)

- SSG builds fail because next-intl uses headers
- Next.js 16 imposed stricter SSG restrictions
- Check: https://github.com/amannn/next-intl/issues/2064

### E2E Testing with i18n

When testing with Playwright, handle both languages:

```typescript
// Match either English or Japanese text
await expect(page.getByRole("button", { name: /Save|保存/i })).toBeVisible()
await expect(page.getByText(/Invalid credentials|認証エラー/i)).toBeVisible()
```

## Anti-Patterns

### Hardcoded Strings

```typescript
// Bad
<button>Save</button>

// Good
const t = useTranslations("common")
<button>{t("save")}</button>
```

### Missing setRequestLocale

```typescript
// Bad: Missing setRequestLocale
export default async function Page({ params }) {
  const { locale } = await params
  const t = await getTranslations("common")  // Works but slow
}

// Good: With setRequestLocale
export default async function Page({ params }) {
  const { locale } = await params
  setRequestLocale(locale)  // Required!
  const t = await getTranslations("common")
}
```
